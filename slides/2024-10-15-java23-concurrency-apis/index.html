<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui"><title>Java 23: Mehr Handlung, mehr Übersicht</title><link rel="stylesheet" href="../../_reveal.js/css/reset.css"><link rel="stylesheet" href="../../_reveal.js/css/reveal.css"><link rel="stylesheet" href="../../_reveal.js/css/theme/adesso.css" id="theme"><!--This CSS is generated by the Asciidoctor reveal.js converter to further integrate AsciiDoc's existing semantic with reveal.js--><style type="text/css">.reveal div.right {
  float: right
}

/* listing block */
.reveal .listingblock.stretch > .content {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre {
  height: 100%
}

.reveal .listingblock.stretch > .content > pre > code {
  height: 100%;
  max-height: 100%
}

/* tables */
table {
  border-collapse: collapse;
  border-spacing: 0
}

table {
  margin-bottom: 1.25em;
  border: solid 1px #dedede
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
  padding: .5em .625em .625em;
  font-size: inherit;
  text-align: left
}

table tr th, table tr td {
  padding: .5625em .625em;
  font-size: inherit
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
  display: table-cell;
  line-height: 1.6
}

td.tableblock > .content {
  margin-bottom: 1.25em
}

td.tableblock > .content > :last-child {
  margin-bottom: -1.25em
}

table.tableblock, th.tableblock, td.tableblock {
  border: 0 solid #dedede
}

table.grid-all > thead > tr > .tableblock, table.grid-all > tbody > tr > .tableblock {
  border-width: 0 1px 1px 0
}

table.grid-all > tfoot > tr > .tableblock {
  border-width: 1px 1px 0 0
}

table.grid-cols > * > tr > .tableblock {
  border-width: 0 1px 0 0
}

table.grid-rows > thead > tr > .tableblock, table.grid-rows > tbody > tr > .tableblock {
  border-width: 0 0 1px
}

table.grid-rows > tfoot > tr > .tableblock {
  border-width: 1px 0 0
}

table.grid-all > * > tr > .tableblock:last-child, table.grid-cols > * > tr > .tableblock:last-child {
  border-right-width: 0
}

table.grid-all > tbody > tr:last-child > .tableblock, table.grid-all > thead:last-child > tr > .tableblock, table.grid-rows > tbody > tr:last-child > .tableblock, table.grid-rows > thead:last-child > tr > .tableblock {
  border-bottom-width: 0
}

table.frame-all {
  border-width: 1px
}

table.frame-sides {
  border-width: 0 1px
}

table.frame-topbot, table.frame-ends {
  border-width: 1px 0
}

.reveal table th.halign-left, .reveal table td.halign-left {
  text-align: left
}

.reveal table th.halign-right, .reveal table td.halign-right {
  text-align: right
}

.reveal table th.halign-center, .reveal table td.halign-center {
  text-align: center
}

.reveal table th.valign-top, .reveal table td.valign-top {
  vertical-align: top
}

.reveal table th.valign-bottom, .reveal table td.valign-bottom {
  vertical-align: bottom
}

.reveal table th.valign-middle, .reveal table td.valign-middle {
  vertical-align: middle
}

table thead th, table tfoot th {
  font-weight: bold
}

tbody tr th {
  display: table-cell;
  line-height: 1.6
}

tbody tr th, tbody tr th p, tfoot tr th, tfoot tr th p {
  font-weight: bold
}

thead {
  display: table-header-group
}

.reveal table.grid-none th, .reveal table.grid-none td {
  border-bottom: 0 !important
}

/* kbd macro */
kbd {
  font-family: "Droid Sans Mono", "DejaVu Sans Mono", monospace;
  display: inline-block;
  color: rgba(0, 0, 0, .8);
  font-size: .65em;
  line-height: 1.45;
  background: #f7f7f7;
  border: 1px solid #ccc;
  -webkit-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em white inset;
  box-shadow: 0 1px 0 rgba(0, 0, 0, .2), 0 0 0 .1em #fff inset;
  margin: 0 .15em;
  padding: .2em .5em;
  vertical-align: middle;
  position: relative;
  top: -.1em;
  white-space: nowrap
}

.keyseq kbd:first-child {
  margin-left: 0
}

.keyseq kbd:last-child {
  margin-right: 0
}

/* callouts */
.conum[data-value] {
  display: inline-block;
  color: #fff !important;
  background: rgba(0, 0, 0, .8);
  -webkit-border-radius: 50%;
  border-radius: 50%;
  text-align: center;
  font-size: .75em;
  width: 1.67em;
  height: 1.67em;
  line-height: 1.67em;
  font-family: "Open Sans", "DejaVu Sans", sans-serif;
  font-style: normal;
  font-weight: bold
}

.conum[data-value] * {
  color: #fff !important
}

.conum[data-value] + b {
  display: none
}

.conum[data-value]:after {
  content: attr(data-value)
}

pre .conum[data-value] {
  position: relative;
  top: -.125em
}

b.conum * {
  color: inherit !important
}

.conum:not([data-value]):empty {
  display: none
}

/* Callout list */
.hdlist > table, .colist > table {
  border: 0;
  background: none
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
  background: none
}

td.hdlist1, td.hdlist2 {
  vertical-align: top;
  padding: 0 .625em
}

td.hdlist1 {
  font-weight: bold;
  padding-bottom: 1.25em
}

/* Disabled from Asciidoctor CSS because it caused callout list to go under the
 * source listing when .stretch is applied (see #335)
 * .literalblock+.colist,.listingblock+.colist{margin-top:-.5em} */
.colist td:not([class]):first-child {
  padding: .4em .75em 0;
  line-height: 1;
  vertical-align: top
}

.colist td:not([class]):first-child img {
  max-width: none
}

.colist td:not([class]):last-child {
  padding: .25em 0
}

/* Override Asciidoctor CSS that causes issues with reveal.js features */
.reveal .hljs table {
  border: 0
}

/* Callout list rows would have a bottom border with some reveal.js themes (see #335) */
.reveal .colist > table th, .reveal .colist > table td {
  border-bottom: 0
}

/* Fixes line height with Highlight.js source listing when linenums enabled (see #331) */
.reveal .hljs table thead tr th, .reveal .hljs table tfoot tr th, .reveal .hljs table tbody tr td, .reveal .hljs table tr td, .reveal .hljs table tfoot tr td {
  line-height: inherit
}

/* Columns layout */
.columns .slide-content {
  display: flex;
}

.columns.wrap .slide-content {
  flex-wrap: wrap;
}

.columns.is-vcentered .slide-content {
  align-items: center;
}

.columns .slide-content > .column {
  display: block;
  flex-basis: 0;
  flex-grow: 1;
  flex-shrink: 1;
}

.columns .slide-content > .column > * {
  padding: .75rem;
}

/* See #353 */
.columns.wrap .slide-content > .column {
  flex-basis: auto;
}

.columns .slide-content > .column.is-full {
  flex: none;
  width: 100%;
}

.columns .slide-content > .column.is-four-fifths {
  flex: none;
  width: 80%;
}

.columns .slide-content > .column.is-three-quarters {
  flex: none;
  width: 75%;
}

.columns .slide-content > .column.is-two-thirds {
  flex: none;
  width: 66.6666%;
}

.columns .slide-content > .column.is-three-fifths {
  flex: none;
  width: 60%;
}

.columns .slide-content > .column.is-half {
  flex: none;
  width: 50%;
}

.columns .slide-content > .column.is-two-fifths {
  flex: none;
  width: 40%;
}

.columns .slide-content > .column.is-one-third {
  flex: none;
  width: 33.3333%;
}

.columns .slide-content > .column.is-one-quarter {
  flex: none;
  width: 25%;
}

.columns .slide-content > .column.is-one-fifth {
  flex: none;
  width: 20%;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.columns .slide-content > .column.has-text-left {
  text-align: left;
}

.columns .slide-content > .column.has-text-justified {
  text-align: justify;
}

.columns .slide-content > .column.has-text-right {
  text-align: right;
}

.text-left {
  text-align: left !important
}

.text-right {
  text-align: right !important
}

.text-center {
  text-align: center !important
}

.text-justify {
  text-align: justify !important
}

.footnotes {
  border-top: 1px solid rgba(0, 0, 0, 0.2);
  padding: 0.5em 0 0 0;
  font-size: 0.65em;
  margin-top: 4em;
}
</style><!--Printing and PDF exports--><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? "../../_reveal.js/css/print/pdf.css" : "../../_reveal.js/css/print/paper.css";
document.getElementsByTagName( 'head' )[0].appendChild( link );</script></head><body><div class="reveal"><div class="slides"><section class="title" data-state="title"><h1>Java 23</h1><h2>Mehr Handlung, mehr Übersicht</h2><div class="preamble"><link rel="stylesheet" href="../../_highlight.js/github.min.css">
<script src="../../_highlight.js/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
<div class="event">
	<div class="participant">
		<img src="../../_shared/images/merlin-at-devoxx.jpg" class="logo">
		<div class="name">
			<p><a href="https://mboegers.github.io">Merlin B&ouml;gershausen</a></p>
			<p><a href="https://fosstodon.org/@MBoegie" title="Merlin on Fosstodon">MBoegie@fosstodon.org</a></p>
			<p><a href="https://twitter.com/mboegie" title="Merlin on Twitter">@mboegie</a></p>
		</div>
	</div>
	<div class="participant">
		<a href="https://java.bettercode.eu/"><img src="../../_shared/images/hosts/bettercode_java.png" class="logo" style="logo"></a>
		<div class="name">
			<p><a href="https://java.bettercode.eu/">betterCode()</a></p>
			<p><a href="https://twitter.com/bettercodeconf" style="{host-twitter-style}">@bettercodeconf</a></p>
		</div>
	</div>
	<div class="participant">
		<a href="https://www.adesso.de/de/"><img src="../../_shared/images/adesso_logo_NoClaim.png" class="logo"></a>
		<div class="name">
			<p>Java Software Engineer</p>
            <p>Line of Business Public</p>
		</div>
	</div>
	<div class="participant">
		<a href="https://ace.oracle.com/apex/ace/profile/mboegers"><img src="../../_shared/images/ACEAssociate.svg" class="logo"></a>
		<div class="name">
			<p>Oracle ACE Associate</p>
		</div>
	</div>
</div>
<header>
    <div class="host">
        <a href="https://java.bettercode.eu/"><img src="../../_shared/images/hosts/bettercode_java.png" class="logo" style="logo"></a>
        <div class="name">
            <p><a href="https://java.bettercode.eu/">betterCode()</a> / <a href="https://twitter.com/bettercodeconf" style="{host-twitter-style}">@bettercodeconf</a></p>
        </div>
    </div>
    <div class="participant">
        <img src="../../_shared/images/merlin-at-devoxx.jpg" class="logo">
        <a href="https://www.adesso.de/de/"><img src="../../_shared/images/adesso_logo_NoClaim.png" class="logo"></a>
        <div class="name"><p>
            Merlin B&ouml;gershausen
            / <a href="https://twitter.com/mboegie" title="Merlin on Twitter">@mboegie</a>
        </p></div>
    </div>
</header>
<!-- Just adding a footer does not work because reveal.js puts it into the slides and we couldn't get it out via CSS. So we move it via JavaScript. -->
<script>
	document.addEventListener('DOMContentLoaded', function () {
		document.body.appendChild(document.querySelector('header'));
	})
</script></div></section>
<section><section id="_️_recap_on_threads_️" data-background-image="images/AamCjmYS.jpg" data-background-size="cover"><h2>♻️ Recap on Threads ♻️</h2><div class="slide-content"></div></section><section id="_threads_in_general" class="columns"><h2>Threads in general</h2><div class="slide-content"><div class="openblock column is-one-third"><div class="content"><div class="imageblock"><img src="images/generated/thread_forking.svg" alt="thread forking" height="400px"></div></div></div>
<div class="openblock column"><div class="content"><div class="imageblock"><img src="images/generated/thread_states.svg" alt="thread states" height="400px"></div></div></div>
<aside class="notes"><div class="paragraph"><p>Threads in general are used to group Activities in a certen order.
I thread is froked from its parent and at some point is joined again.
Between <strong>fork</strong> and <strong>join</strong> a thread executes operations in a defined order.</p></div>
<div class="paragraph"><p>If multiple threads are run in paralell concurrency problems like syncronization and concurrent access enter the game.</p></div>
<div class="paragraph"><p>If a thread is managed by the OS, outside of the JVM, it refered to as a platform thread.</p></div>
<div class="paragraph"><p>Threads in general have a state model that look different from every OS but it can be condensed to the JVM states on the right.
They start as new, here they canot run yet.
After moving to Runable thes are considered for scheduling.
Blocked and Waiting are two simlar states that are of interest if we consider Scheduling.
If terminated a thread is ready for disposal and will not receive any computation time.</p></div></aside></div></section><section id="_threads_in_java"><h2>Threads in Java</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">class ExampleThread extends Thread {
  public void run() { /* Do it */}
}
var t1 = new ExampleThread();

class ExampleRunable implements Runable {
  public void run() { /* Do it again */}
}
var runable = new ExampleRunable();
var t2 = new Thread(runable);

t2.start(); t1.start();
t2.join(); t1.join();</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>Threads in Java are modeled as instances of the class java.lang.Thread.
The operations can be defined within the run method.
An instance of Thread is the smallest unit of scheduable work in the JVM.</p></div>
<div class="paragraph"><p>A runable abstracts from Thread, it has the same Interface and seems to address a simlar need: a Unit of concurrent work to execute at some point.
The key difference here is that java.lang.Runable is not bound to a specific platform thread and can be scheduled by the JVM.
How runables there are scheduled/or better executed are determined by the concurrency model we work with.</p></div>
<div class="paragraph"><p>This API there since Java 1.0 with only minor changes at the API level.</p></div></aside></div></section><section id="_concurrency_models_1" class="columns"><h2>Concurrency Models <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="openblock column"><div class="content"><div class="paragraph"><p><strong>ExecutorService</strong></p></div>
<div class="ulist"><ul><li><p>Thread Pool Management</p></li><li><p>reuse OS Threads</p></li></ul></div></div></div>
<div class="openblock column"><div class="content"><div class="paragraph"><p><strong>CompletableFuture</strong></p></div>
<div class="ulist"><ul><li><p>Composing asyncron operations</p></li><li><p>handling Results</p></li></ul></div></div></div>
<aside class="notes"><div class="paragraph"><p>Credits to Hanno Embret for this comparison.</p></div>
<div class="paragraph"><p><strong>ExecutorServicer</strong> (since Java 1.5) is an Interface that is used to execute scheduable Units (Runables).
They can be executed on one more multiple Plattform Threads, usually they reuse there Threads.
Very basic and even Error Handling relies on propagation and nesting of exceptions.</p></div>
<div class="paragraph"><p><strong>CompletableFuture</strong> (since 1.8) is a Future that with completion and defined semantics on multiple threads.
Extends the Future (Since Java 1.5) that models asyncronous openrations.</p></div>
<div class="paragraph"><p>Both are somehow connectable but its not that straingt forward.</p></div></aside></div><div class="footnotes"><div class="footnote">1. Credits to Hanno Embregts on Devoxx.BE 2024, <a href="https://hanno.codes/slides/javas-concurrency-journey-continues/devoxx-2024/#/3/21/5">slides</a></div></div></section></section>
<section><section id="_jep_444_virtual_threads" data-background-image="images/dhhhSRjf.jpg" data-background-size="cover"><h2>JEP 444 Virtual Threads</h2><div class="slide-content"><div class="paragraph fragment"><p>Virtual threads are <span class="step highlight-blue fragment">lightweight</span> threads that <span class="step highlight-blue fragment">improve Maintanace</span> and <span class="step highlight-blue fragment">Obervability</span>.</p></div><aside class="notes"><div class="paragraph"><p>Now that we spend 10 minutes on well know and present stuff.
We can dive into something cool an new.</p></div>
<div class="paragraph"><p>Virtual Threads, lets see how much "new" is in there, by looking at the goals first.</p></div>
<div class="paragraph"><p><strong>CLICK and Read</strong></p></div>
<div class="paragraph"><p>They are planed to be lightweight and contribute to maintainabllility and oberservability.
At the same time they still are threads with the well known semantics, somehow.</p></div>
<div class="paragraph"><p>Lets dive into the proposed changes and decide on ourself.</p></div></aside></div></section><section id="_platform_vs_virtual"><h2>Platform vs. Virtual</h2><div class="slide-content"><div class="imageblock"><img src="images/generated/thread_normal.svg" alt="thread normal"></div>
<aside class="notes"><div class="paragraph"><p>Lets take a look inside the OS/JVM connection.
Please note that we look at basic thread interaction and not use any thread pooling.</p></div>
<div class="paragraph"><p>On the left there are two old Platform Threads that wrap around a Runnable.
With each Thread instance there is an associated OS Thread forked from the JVM Main PID.
The number if the OS Threads per process is guarded by the OS Kernel.</p></div>
<div class="paragraph"><p>On the right there are two process utilizing the new JVM Virtual Threads.
Each Virtual thread is managed by the JVM itself.
It is therefor more lightweight and only has the JVM needed stuff.
If a virtual Thread is selected for execution it is assigned a already present OS Thread.</p></div></aside></div></section><section id="_creation_of_virtual"><h2>Creation of Virtual</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">Thread.ofVirtual().start(() -&gt; doIOStuffInParallel());

Thread.ofPlatform() // is new as well</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>In JEP 444 the Thread API got two FactoryMethods for ThreadBuilders, for virtual and Platform.
Each of the Builder supports the configuration of all maybe needed values and finally the Runnable to execute.</p></div>
<div class="paragraph"><p>Two basic remarks, don&#8217;t pool them and be careful with ThreadLocals.
The pooling is only needed for Platform Threads and virtuals are designed to be throwaway instances.
ThreadLocals are copied for every thread, virtuals threads are designed to be numerous.
With basic math it is easy to see that ThreadLocals and Virtual Threads are a dangerous road to ride.</p></div>
<div class="paragraph"><p>And Finally: Friends don&#8217;t let friends create their own thread!</p></div></aside></div></section><section id="_better_use_executors"><h2>Better use Executors</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">Executors.newVirtualThreadPerTaskExecutor()
	.submit(() -&gt; doIOStuffInParallel());</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>For most developers Executors are the way to go, just because DIY is possible but hard to get right.
Greeting to the ARCH people, I am fascinated by your will.</p></div>
<div class="paragraph"><p>Executors Utility got a new FactoryMethod called newVirtualThreadPerTaskExecutor.
This name breaks with the idea of executors, at the first sight.
But because the JVM handles the bounded number of OS Thread and assignes virtual threads when needed, the JVM acts as executor.
We don&#8217;t need an additional!</p></div></aside></div></section><section id="_awesome_now_what"><h2>Awesome, now what?</h2><div class="slide-content"><div class="ulist"><ul><li><p>Lightweight?</p></li><li><p>Maintainabllility?</p></li><li><p>Oberservability?</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>The JEP promissed Lightweight, maintainable and oberservable threads.</p></div>
<div class="paragraph"><p>We have the JVM Threads and internal scheduling.
Because everything is internal we can understand the traces.
Because everything is internal, we can debug everything.</p></div>
<div class="paragraph"><p>Mostly virtual threads are the foundation of all new things around concurrent programming in Java.
Two of them are Scoped Values and Structured Concurrency.</p></div></aside></div></section><section id="_example_we_work_with"><h2>Example we Work with</h2><div class="slide-content"><div class="openblock step"><div class="content"><div class="imageblock"><img src="images/generated/example_class.svg" alt="example class" height="400px"></div></div></div>
<aside class="notes"><div class="paragraph"><p>Today I want to use a RuleEngine as example to work with.
A lot of poeple dislike RuleEniges for various reasons but they can be simple.</p></div>
<div class="paragraph"><p><strong>CLICK</strong></p></div>
<div class="paragraph"><p>A RuleEngine is nothing more than a List of Rules that are executed when input data is provided.
Our Rules here define to methods to read adress and Names from somewhere and have a fire Method to implement where the data rule is executed.
At first we stay at this level and later one we see the code in small bites.</p></div>
<div class="paragraph"><p>One thing to notice is that the Engine holds an SSLContext that is intended to be used in execution.
It can be used for Requests by the rules, this is an often see situation in Frameworks.
The users code (RuleImplementation) needs something from the Framework to do the job, often in thread-safe and concurrent ways.</p></div>
<div class="paragraph"><p><strong>Here is missing that we want cocurrency and thread safty.</strong></p></div></aside></div></section></section>
<section><section id="_jep_481_scoped_values" data-background-image="images/SVT84DAs.jpg" data-background-size="cover"><h2>JEP 481 Scoped Values</h2><div class="slide-content"><div class="paragraph"><p>Share <span class="step highlight-blue fragment">immutable data</span> between callees <span class="step highlight-blue fragment">within a thread</span> and <span class="step highlight-blue fragment">child threads</span>.</p></div></div></section><section id="_concept"><h2>Concept</h2><div class="slide-content"><div class="imageblock"><img src="images/generated/scoped_values_concept.svg" alt="scoped values concept" height="400px"></div>
<aside class="notes"><div class="paragraph"><p>This example assumes that Threads T1,T2 are forked from the Blue Thread and and T3 and T4 from the YellowThread.</p></div>
<div class="paragraph"><p>In blue we see how the SSLContext would be passed with a ThreadLocal.
Very thread T1 and T2 initializes it&#8217;s own instance at creation time.
For numerous threads its a waste of heap space and very efficient because initialization of SSLContext is telecommuting.</p></div>
<div class="paragraph"><p>On the yellow we see the same situation solved with a ScopedValue.
Each, virtual, thread T3 and T4 refe to the same HeapAdress and therefore use the same instance.</p></div>
<div class="paragraph"><p>This way it is secure that memory is not polluted with SSLContexts even when we have a million threads in parallel.</p></div></aside></div></section><section id="_goals_of_scoped_values"><h2>Goals of Scoped Values</h2><div class="slide-content"><div class="ulist"><ul><li><p>🥅 Ease of use</p></li><li><p>🥅 Comprehensibility</p></li><li><p>🥅 Robustness</p></li><li><p>🥅 Performance</p></li></ul></div>
<aside class="notes"><div class="paragraph"><p>Before we see the API lets quickly look at the goals so we can make our own mind.</p></div>
<div class="ulist"><ul><li><p>Ease of use — It should be easy to reason about dataflow.</p></li><li><p>Comprehensibility — The lifetime of shared data should be apparent from the syntactic structure of code.</p></li><li><p>Robustness — Data shared by a caller should be retrievable only by legitimate callees.</p></li><li><p>Performance — Data should be efficiently sharable across a large number of threads.</p></li></ul></div></aside></div></section><section id="_scopesvalues_api"><h2>ScopesValues API</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">final static ScopedValue&lt;SSLContext&gt; VAL
                    = ScopedValue.newInstance();

ScopedValue.where(VAL, value)
           .run(() -&gt; VAL.get());

ScopedValue.runWhere(VAL, value, () -&gt; /* ... */);</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>The ScopedValue API is small but powerful.</p></div>
<div class="paragraph"><p>A ScopedValue Instance is a Generic value holder.
A new Instance is easily received via the newInstance call in the first line, this is the only way to receive an instance.</p></div>
<div class="paragraph"><p>Before the value can be accessed it has to be set, this is done with the static where Method using the ScopedValue instance as key.</p></div>
<div class="paragraph"><p>The forwarding of the value to child thread has to be done at creation of the child, but to activate the binding a Runnable has to bound with the run method.
This creates an virtual thread wrapping the Runnable implicitly.</p></div>
<div class="paragraph"><p>Configuration and execution can be done in one step with the shorthand runWhere Method.
Childs can rebind scopedValues for their children, this will not effect the praent scope.</p></div></aside></div></section><section id="_framework_creation"><h2>Framework - Creation</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">private final static ScopedValue&lt;Map&lt;String, String&gt;&gt;
    INPUTDATA = ScopedValue.newInstance();

private final static ScopedValue&lt;SSLContext&gt;
    SSL_CTX = ScopedValue.newInstance();</code></pre></div></div></div></section><section id="_framework_config"><h2>Framework -Config</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">ScopedValue.Carrier executionScope = ScopedValue
    .where(INPUTDATA, Map.copyOf(data))
    .where(SSL_CTX, SSLContext.getDefault());</code></pre></div></div></div></section><section id="_framework_execution"><h2>Framework - Execution</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">// ScopedValue.Carrier executionScope;

for (var r : rules) {
    executionScope.run(r::fire);
}</code></pre></div></div></div></section><section id="_usercode_access_i"><h2>Usercode - Access I</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">//ScopedValue&lt;Map&lt;String, String&gt;&gt; INPUTDATA;

String inputName = INPUTDATA
        .orElseThrow(new IllegalArgumentException())
        .getOrDefault("name", "JON");</code></pre></div></div></div></section><section id="_usercode_access_ii"><h2>Usercode - Access II</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">// ScopedValue&lt;SSLContext&gt; SSL_CTX

if(SSL_CTX.isBound()) {
    intputName = "%s %s".formatted(
            inputName, getLastName(SSL_CTX.get()));
}</code></pre></div></div></div></section><section id="_comparison_1" class="columns"><h2>Comparison <sup class="footnote">[<span class="footnote" title="View footnote.">1</span>]</sup></h2><div class="slide-content"><div class="openblock column"><div class="content"><div class="paragraph"><p><strong>ScopedValues</strong></p></div>
<div class="ulist"><ul><li><p>Immutable Carrier</p></li><li><p>Same instance</p></li><li><p>Rebindable</p></li></ul></div></div></div>
<div class="openblock column"><div class="content"><div class="paragraph"><p><strong>ThreadLocal</strong></p></div>
<div class="ulist"><ul><li><p>Supplier</p></li><li><p>Instance per Thread</p></li><li><p>Mutable Value</p></li></ul></div></div></div>
<aside class="notes"><div class="paragraph"><p>For the end lets have a small</p></div></aside></div><div class="footnotes"><div class="footnote">1. full length comparison by Alex Klimenko on <a href="https://medium.com/@alxkm/threadlocal-vs-scopedvalue-a348c37658d8">Medium</a></div></div></section></section>
<section><section id="_jep_480_stuctured_concurrency" data-background-image="images/wpEBCJQU.jpg" data-background-size="cover"><h2>JEP 480 Stuctured Concurrency</h2><div class="slide-content"><div class="paragraph"><p>Treat groups of <span class="step highlight-blue fragment">related tasks</span> running in different threads as a <span class="step highlight-blue fragment">single unit</span> of work, thereby streamlining <span class="step highlight-blue fragment">error handling and cancellation, improving reliability, and enhancing observability</span>.</p></div></div></section><section id="_concept_2"><h2>Concept</h2><div class="slide-content"><div class="imageblock"><img src="images/generated/structured_concurrency_concept.svg" alt="structured concurrency concept" height="400px"></div>
<aside class="notes"><div class="paragraph"><p>If we have a task like a rule that is executed for two separate datasets (like my wife vanessa and me) that are independent tasks to execute.
It is natural to model them as Method with a parameter.</p></div>
<div class="paragraph"><p>Each execution does the same, it generates an Answer based on the name and address.
The address and name has to be read from somewhere which consumes some time.
These tasks are related but not depending on each other, a perfect situation to read them concurrently as they usually wait for IO to happen.</p></div>
<div class="paragraph"><p>We can do this with StructuredConcurrency.</p></div></aside></div></section><section id="_task_scope_api"><h2>Task Scope API</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">public class StructuredTaskScope&lt;T&gt; implements AutoCloseable {
  public &lt;U extends T&gt; Subtask&lt;U&gt;
        fork(Callable&lt;? extends U&gt; task);

  public StructuredTaskScope&lt;T&gt; join()
        throws InterruptedException;
  public StructuredTaskScope&lt;T&gt; joinUntil(Instant deadline)
        throws InterruptedException, TimeoutException;

  public void shutdown();
  public void close();
}</code></pre></div></div>
<aside class="notes"><div class="paragraph"><p>The general workflow of code using StructuredTaskScope is:</p></div>
<div class="olist arabic"><ol class="arabic"><li><p>Create a scope. The thread that creates the scope is its owner.</p></li><li><p>Use the fork(Callable) method to fork subtasks in the scope.</p></li><li><p>At any time, any of the subtasks, or the scope&#8217;s owner, may call the scope&#8217;s shutdown() method to cancel unfinished subtasks and prevent the forking of new subtasks.</p></li><li><p>The scope&#8217;s owner joins the scope, i.e., all of its subtasks, as a unit. The owner can call the scope&#8217;s join() method, to wait until all subtasks have either completed (successfully or not) or been cancelled via shutdown(). Alternatively, it can call the scope&#8217;s joinUntil(java.time.Instant) method, to wait up to a deadline.</p></li><li><p>After joining, handle any errors in the subtasks and process their results.</p></li><li><p>Close the scope, usually implicitly via try-with-resources. This shuts down the scope, if it is not already shut down, and waits for any subtasks that have been cancelled but not yet completed to complete.</p></li></ol></div></aside></div></section><section id="_shutdown_policies" class="columns"><h2>Shutdown Policies</h2><div class="slide-content"><div class="openblock column"><div class="content"><div class="paragraph"><p><strong>ShutdownOnFailure</strong>
first task failed</p></div></div></div>
<div class="openblock column"><div class="content"><div class="paragraph"><p><strong>ShutdownOnSuccess</strong>
first task successfully terminates</p></div></div></div></div></section><section id="_structured_concurrency_in_rule"><h2>Structured Concurrency in Rule</h2><div class="slide-content"><div class="listingblock"><div class="content"><pre class="highlight"><code class="language-java" data-lang="java">try (var scope = new StructuredTaskScope.ShutdownOnFailure()){
    Supplier&lt;String&gt; adr = scope.fork(() -&gt; readAddress());

    scope.join().throwIfFailed();

    var addres = adr.get();
} catch (ExecutionException | InterruptedException e) {
    throw new RuntimeException(e);
}</code></pre></div></div></div></section><section id="_final_words"><h2>Final words</h2><div class="slide-content"><div class="ulist"><ul><li><p>Never pool VirtualThreads</p></li><li><p>Migrate immediately</p></li><li><p>ThreadLocal never mutated &#8658; ScopedValues</p></li><li><p>IO Concurrency &#8658; StructuredConcurrency</p></li></ul></div>
<div class="paragraph"><p><a href="https://gist.github.com/MBoegers/87fa0928c46e037155dbc7d48aaf7553">GitHub GIST</a> with full code</p></div>
<aside class="notes"><div class="ulist"><ul><li><p>Never Pool Virtual threads</p></li><li><p>Migrate to Virtual threads now to benefit</p></li><li><p>use ScopedValues if you want the same value down the stack</p><div class="ulist"><ul><li><p>if you want just a starting point or mutate it, stick with threadlocal</p></li></ul></div></li><li><p>Handing ScopedValuse to the children seems hard ATM, but this seem to be on the agenda for the next iterations</p></li><li><p>What we have seen</p><div class="ulist"><ul><li><p>Virutal Threads as lightway JDK Managed scheduabl unit that is theoretically unbound in there number</p></li><li><p>Scoped Values to pass immutable values from the prant thread (scope) to the child threads</p></li><li><p>SturcturedConcurrency to easly oversee what may happen concurrrently, at which point the tasks are joind together and where errors are handled</p></li></ul></div></li><li><p>Link to Github</p></li></ul></div></aside></div></section></section>
<section id="_contact" class="columns about" data-background-image="../../_shared/images/gluehbirnen.jpg" data-background-size="cover"><h2>Contact</h2><div class="slide-content">
<div class="openblock column"><div class="content"><h3>Me</h3>
<a href="https://fosstodon.org/@MBoegie" title="Merlin on Fosstodon">MBoegie@fosstodon.org</a> //
<a href="https://twitter.com/mboegie">@MBoegi</a> //
<a href="https://github.com/mboegers">MBoegers</a>
<br>
<h3>adesso</h3>
<a href="https://adesso.de">Infos</a> //
<a href="https://www.adesso.de/de/news/blog">DevBlog</a>
<h3>Approach direct</h3>
I'm here all day with cookies!</div></div>
<div class="openblock column is-one-third"><div class="content"><h3>Jobs</h3>
<div class="imageblock"><img src="../../_shared/images/qrcode_adesso_jobs.png" alt="qrcode adesso jobs"></div></div></div>
<aside class="notes"><div class="paragraph"><p>Follow me on Twitter for the slides.</p></div>
<div class="paragraph"><p>Look out for cool jobs with new Java at adesso SE.</p></div>
<div class="paragraph"><p>I blog about java at adesso dev blog and in my github page.</p></div></aside></div></section>
<section id="_image_credits"><h2>Image Credits</h2><div class="slide-content"><div class="ulist"><ul><li><p>Knited Speach Blubled generetd with <a href="https://deepai.org/gallery-item/e7ee5d480bed4d359b70607caf8b7f39/multiple-speech-bubbles-made-out-of-knited-wo_uKTYSNr.jpg.html">deepai.org</a></p></li><li><p>Virtual reality background generetd with <a href="https://deepai.org/gallery-item/7668458efa334d2081f1d41484319e6b/multiple-concurrent-actions-in-virtual-reality-3be37f.jpg.html">deepai.org</a></p></li><li><p>Elderly Person handing over treats generated with <a href="https://deepai.org/gallery-item/abec1ea3e0de460f9c5ac32b8128391c/elderly-person-handing-over-treats-to-todlers.jpg.html">deepai.org</a></p></li><li><p>Chaos of pipes and notations generated with <a href="https://deepai.org/gallery-item/3a428d1087004b27bb3caea2c0e7e0fd/a-chaos-of-pipes-that-contains-bpmn-notations.jpg.html">deepai.org</a></p></li></ul></div></div></section></div></div><script src="../../_reveal.js/js/reveal.js"></script><script>Array.prototype.slice.call(document.querySelectorAll('.slides section')).forEach(function(slide) {
  if (slide.getAttribute('data-background-color')) return;
  // user needs to explicitly say he wants CSS color to override otherwise we might break custom css or theme (#226)
  if (!(slide.classList.contains('canvas') || slide.classList.contains('background'))) return;
  var bgColor = getComputedStyle(slide).backgroundColor;
  if (bgColor !== 'rgba(0, 0, 0, 0)' && bgColor !== 'transparent') {
    slide.setAttribute('data-background-color', bgColor);
    slide.style.backgroundColor = 'transparent';
  }
});

// More info about config & dependencies:
// - https://github.com/hakimel/reveal.js#configuration
// - https://github.com/hakimel/reveal.js#dependencies
Reveal.initialize({
  // Display presentation control arrows
  controls: false,
  // Help the user learn the controls by providing hints, for example by
  // bouncing the down arrow when they first encounter a vertical slide
  controlsTutorial: false,
  // Determines where controls appear, "edges" or "bottom-right"
  controlsLayout: 'bottom-right',
  // Visibility rule for backwards navigation arrows; "faded", "hidden"
  // or "visible"
  controlsBackArrows: 'faded',
  // Display a presentation progress bar
  progress: false,
  // Display the page number of the current slide
  slideNumber: false,
  // Control which views the slide number displays on
  showSlideNumber: 'all',
  // Add the current slide number to the URL hash so that reloading the
  // page/copying the URL will return you to the same slide
  hash: false,
  // Push each slide change to the browser history. Implies `hash: true`
  history: true,
  // Enable keyboard shortcuts for navigation
  keyboard: true,
  // Enable the slide overview mode
  overview: true,
  // Disables the default reveal.js slide layout so that you can use custom CSS layout
  disableLayout: false,
  // Vertical centering of slides
  center: true,
  // Enables touch navigation on devices with touch input
  touch: true,
  // Loop the presentation
  loop: false,
  // Change the presentation direction to be RTL
  rtl: false,
  // See https://github.com/hakimel/reveal.js/#navigation-mode
  navigationMode: 'default',
  // Randomizes the order of slides each time the presentation loads
  shuffle: false,
  // Turns fragments on and off globally
  fragments: true,
  // Flags whether to include the current fragment in the URL,
  // so that reloading brings you to the same fragment position
  fragmentInURL: false,
  // Flags if the presentation is running in an embedded mode,
  // i.e. contained within a limited portion of the screen
  embedded: false,
  // Flags if we should show a help overlay when the questionmark
  // key is pressed
  help: true,
  // Flags if speaker notes should be visible to all viewers
  showNotes: false,
  // Global override for autolaying embedded media (video/audio/iframe)
  // - null: Media will only autoplay if data-autoplay is present
  // - true: All media will autoplay, regardless of individual setting
  // - false: No media will autoplay, regardless of individual setting
  autoPlayMedia: null,
  // Global override for preloading lazy-loaded iframes
  // - null: Iframes with data-src AND data-preload will be loaded when within
  //   the viewDistance, iframes with only data-src will be loaded when visible
  // - true: All iframes with data-src will be loaded when within the viewDistance
  // - false: All iframes with data-src will be loaded only when visible
  preloadIframes: null,
  // Number of milliseconds between automatically proceeding to the
  // next slide, disabled when set to 0, this value can be overwritten
  // by using a data-autoslide attribute on your slides
  autoSlide: 0,
  // Stop auto-sliding after user input
  autoSlideStoppable: true,
  // Use this method for navigation when auto-sliding
  autoSlideMethod: Reveal.navigateNext,
  // Specify the average time in seconds that you think you will spend
  // presenting each slide. This is used to show a pacing timer in the
  // speaker view
  defaultTiming: 120,
  // Specify the total time in seconds that is available to
  // present.  If this is set to a nonzero value, the pacing
  // timer will work out the time available for each slide,
  // instead of using the defaultTiming value
  totalTime: 0,
  // Specify the minimum amount of time you want to allot to
  // each slide, if using the totalTime calculation method.  If
  // the automated time allocation causes slide pacing to fall
  // below this threshold, then you will see an alert in the
  // speaker notes window
  minimumTimePerSlide: 0,
  // Enable slide navigation via mouse wheel
  mouseWheel: false,
  // Hide cursor if inactive
  hideInactiveCursor: true,
  // Time before the cursor is hidden (in ms)
  hideCursorTime: 5000,
  // Hides the address bar on mobile devices
  hideAddressBar: true,
  // Opens links in an iframe preview overlay
  // Add `data-preview-link` and `data-preview-link="false"` to customise each link
  // individually
  previewLinks: false,
  // Transition style (e.g., none, fade, slide, convex, concave, zoom)
  transition: 'fade',
  // Transition speed (e.g., default, fast, slow)
  transitionSpeed: 'default',
  // Transition style for full page slide backgrounds (e.g., none, fade, slide, convex, concave, zoom)
  backgroundTransition: 'fade',
  // Number of slides away from the current that are visible
  viewDistance: 3,
  // Number of slides away from the current that are visible on mobile
  // devices. It is advisable to set this to a lower number than
  // viewDistance in order to save resources.
  mobileViewDistance: 3,
  // Parallax background image (e.g., "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'")
  parallaxBackgroundImage: '',
  // Parallax background size in CSS syntax (e.g., "2100px 900px")
  parallaxBackgroundSize: '',
  // Number of pixels to move the parallax background per slide
  // - Calculated automatically unless specified
  // - Set to 0 to disable movement along an axis
  parallaxBackgroundHorizontal: null,
  parallaxBackgroundVertical: null,
  // The display mode that will be used to show slides
  display: 'block',

  // The "normal" size of the presentation, aspect ratio will be preserved
  // when the presentation is scaled to fit different resolutions. Can be
  // specified using percentage units.
  width: 960,
  height: 700,

  // Factor of the display size that should remain empty around the content
  margin: 0.1,

  // Bounds for smallest/largest possible scale to apply to content
  minScale: 0.2,
  maxScale: 1.5,

  // PDF Export Options
  // Put each fragment on a separate page
  pdfSeparateFragments: true,
  // For slides that do not fit on a page, max number of pages
  pdfMaxPagesPerSlide: 1,

  // Optional libraries used to extend on reveal.js
  dependencies: [
      { src: '../../_reveal.js/plugin/zoom-js/zoom.js', async: true },
      { src: '../../_reveal.js/plugin/notes/notes.js', async: true }
  ],

  

});</script><script>var dom = {};
dom.slides = document.querySelector('.reveal .slides');

function getRemainingHeight(element, slideElement, height) {
  height = height || 0;
  if (element) {
    var newHeight, oldHeight = element.style.height;
    // Change the .stretch element height to 0 in order find the height of all
    // the other elements
    element.style.height = '0px';
    // In Overview mode, the parent (.slide) height is set of 700px.
    // Restore it temporarily to its natural height.
    slideElement.style.height = 'auto';
    newHeight = height - slideElement.offsetHeight;
    // Restore the old height, just in case
    element.style.height = oldHeight + 'px';
    // Clear the parent (.slide) height. .removeProperty works in IE9+
    slideElement.style.removeProperty('height');
    return newHeight;
  }
  return height;
}

function layoutSlideContents(width, height) {
  // Handle sizing of elements with the 'stretch' class
  toArray(dom.slides.querySelectorAll('section .stretch')).forEach(function (element) {
    // Determine how much vertical space we can use
    var limit = 5; // hard limit
    var parent = element.parentNode;
    while (parent.nodeName !== 'SECTION' && limit > 0) {
      parent = parent.parentNode;
      limit--;
    }
    if (limit === 0) {
      // unable to find parent, aborting!
      return;
    }
    var remainingHeight = getRemainingHeight(element, parent, height);
    // Consider the aspect ratio of media elements
    if (/(img|video)/gi.test(element.nodeName)) {
      var nw = element.naturalWidth || element.videoWidth, nh = element.naturalHeight || element.videoHeight;
      var es = Math.min(width / nw, remainingHeight / nh);
      element.style.width = (nw * es) + 'px';
      element.style.height = (nh * es) + 'px';
    } else {
      element.style.width = width + 'px';
      element.style.height = remainingHeight + 'px';
    }
  });
}

function toArray(o) {
  return Array.prototype.slice.call(o);
}

Reveal.addEventListener('slidechanged', function () {
  layoutSlideContents(960, 700)
});
Reveal.addEventListener('ready', function () {
  layoutSlideContents(960, 700)
});
Reveal.addEventListener('resize', function () {
  layoutSlideContents(960, 700)
});</script></body></html>